import os

import androguard.core.bytecodes.apk as apk
import androguard.core.bytecodes.dvm as dvm

from dotenv import load_dotenv

load_dotenv()

filename = os.getenv("MALWARE_DIRECTORY")

a = apk.APK(filename)

print("App name:", a.get_app_name())
print("Package name:", a.get_package())

d = dvm.DalvikVMFormat(a.get_dex())

print("Number of classes:", len(d.get_classes()))

perms = a.get_permissions()
print("Permissions:", perms)

api_calls = set(signature for current_class in d.get_classes()
                for current_method in current_class.get_methods()
                if (code := current_method.get_code())
                for i in code.get_bc().get_instructions()
                if i.get_name() == "invoke-virtual"
                if (signature := i.get_output().split(",")[-1].strip(")")[1:-1]))

for call in api_calls:
    print("API call: " + call + "\n")
