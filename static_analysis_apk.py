import os

import androguard.core.bytecodes.apk as apk
import androguard.core.bytecodes.dvm as dvm

from dotenv import load_dotenv


def static_analysis(file):
    # load_dotenv()
    #
    # filename = os.getenv("MALWARE_DIRECTORY")
    apk_features = []
    a = apk.APK(file)

    print("App name:", a.get_app_name())

    d = dvm.DalvikVMFormat(a.get_dex())
    classes = len(d.get_classes())
    perms = a.get_permissions()
    api_calls = set(signature for current_class in d.get_classes()
                    for current_method in current_class.get_methods()
                    if (code := current_method.get_code())
                    for i in code.get_bc().get_instructions()
                    if i.get_name() == "invoke-virtual"
                    if (signature := i.get_output().split(",")[-1].strip(")")[1:-1]))

    apk_features.append(len(perms))
    apk_features.append(classes)
    apk_features.append(len(api_calls))

    return apk_features

