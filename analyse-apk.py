import os

import androguard.core.bytecodes.apk as apk
import androguard.core.bytecodes.dvm as dvm

from dotenv import load_dotenv

load_dotenv()

filename = os.getenv("MALWARE_DIRECTORY")

# Load the APK file
a = apk.APK(filename)

# Print the app name and package name
print("App name:", a.get_app_name())
print("Package name:", a.get_package())

# Load the DEX file
d = dvm.DalvikVMFormat(a.get_dex())

# Print the number of classes
print("Number of classes:", len(d.get_classes()))

# Analyze the permissions
perms = a.get_permissions()
print("Permissions:", perms)

# Analyze the API calls
api_calls = set()
for current_class in d.get_classes():
    for current_method in current_class.get_methods():
        code = current_method.get_code()
        if code:
            for i in code.get_bc().get_instructions():
                if i.get_name() == "invoke-virtual":
                    signature = i.get_output().split(",")[-1].strip(")")[1:-1]
                    api_calls.add(signature)
api_calls = set(api_calls)
for call in api_calls:
    print("API call: " + call + "\n" )
